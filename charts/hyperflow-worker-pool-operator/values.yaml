nodeSelector: {}
image: hyperflowwms/worker-pool-operator:v1.0.0
config:
  data:
    deployment.yml: |-
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: {poolName}
        namespace: {namespace}
        labels:
          app: {poolName}
      spec:
        replicas: {minReplicas}
        selector:
          matchLabels:
            app: {poolName}
        template:
          metadata:
            labels:
              app: {poolName}
          spec:
            terminationGracePeriodSeconds: 300
            nodeSelector:
              hyperflow-wms/nodepool: hfworker
            containers:
              - name: worker
                image: {image}
                command:
                  - /usr/local/bin/dumb-init
                  - --single-child
                  - -v
                  - --
                  - hflow-job-listener.js
                env:
                  - name: QUEUE_NAME
                    value: {queueName}
                  - name: RABBIT_HOSTNAME
                    value: {rabbitHostname}
                  - name: REDIS_URL
                    value: {redisUrl}
                  - name: RABBIT_PREFETCH_SIZE
                    value: '1'
                  - name: HF_VAR_WORK_DIR
                    value: /work_dir
                  - name: HF_VAR_WAIT_FOR_INPUT_FILES
                    value: "0"
                  - name: HF_VAR_NUM_RETRIES
                    value: "1"
                  - name: HF_LOG_NODE_NAME
                    valueFrom:
                      fieldRef:
                        apiVersion: v1
                        fieldPath: spec.nodeName
                  - name: HF_LOG_POD_NAME
                    valueFrom:
                      fieldRef:
                        apiVersion: v1
                        fieldPath: metadata.name
                  - name: HF_LOG_POD_NAMESPACE
                    valueFrom:
                      fieldRef:
                        apiVersion: v1
                        fieldPath: metadata.namespace
                  - name: HF_LOG_POD_IP
                    valueFrom:
                      fieldRef:
                        apiVersion: v1
                        fieldPath: status.podIP
                  - name: HF_LOG_POD_SERVICE_ACCOUNT
                    valueFrom:
                      fieldRef:
                        apiVersion: v1
                        fieldPath: spec.serviceAccountName
                  - name: HF_VAR_FS_MONIT_ENABLED
                    value: "0"
                  - name: HF_VAR_FS_MONIT_COMMAND
                    value: hflow-job-execute $REDIS_URL -a -- 'Gjt5YxVCa:1:5:1' 'Gjt5YxVCa:1:6:1'
                  - name: HF_VAR_FS_MONIT_PATH_PATTERN
                    value: /work_dir/*
                imagePullPolicy: Always
                resources:
                  requests:
                    cpu: {cpuRequests}
                    memory: {memoryRequests}
                volumeMounts:
                  - mountPath: /work_dir
                    name: my-pvc-nfs
                workingDir: /work_dir
                lifecycle:
                  preStop:
                    exec:
                      command: ["sh", "-c", "sleep 5"]
            volumes:
              - name: my-pvc-nfs
                persistentVolumeClaim:
                  claimName: nfs
    vpa.yml: |-
      apiVersion: autoscaling.k8s.io/v1
      kind: VerticalPodAutoscaler
      metadata:
        name: {poolName}
        namespace: {namespace}
        labels:
          app: {poolName}
      spec:
        targetRef:
          apiVersion: "apps/v1"
          kind:       Deployment
          name:       {poolName}
        updatePolicy:
          updateMode: "Initial"
    prometheus-rule.yml: |-
      apiVersion: monitoring.coreos.com/v1
      kind: PrometheusRule
      metadata:
        name: {poolName}
        namespace: {namespace}
        labels:
          prometheus: kube-prometheus # This label is configured as port of the installation of the prometheus operator
          release: monitoring
      spec:
        groups:
          - name: "{poolName}-replication-factor" # Define the name of your rule
            interval: 3s
            rules:
              - record: {poolNameUnderscored}:replication_factor # The name of the metrics you want
                expr: |
                  ceil(
                    0.9
                    *
                    sum(
                      (
                        rabbitmq_queue_messages_ready{{endpoint="rabbitmq-exporter", queue="{queueName}"}}
                        +
                        rabbitmq_queue_messages_unacknowledged{{endpoint="rabbitmq-exporter", queue="{queueName}"}}
                      ) or vector(0)
                    )
                    / max(last_over_time(rabbitmq_queue_messages_total{{endpoint="rabbitmq-exporter"}}[15s]) or vector(1))
                    *
                    min(
                      floor(kube_resourcequota{{namespace="{namespace}", resource="requests.cpu", type="hard"}} / {cpuLimits})
                      or
                      floor(kube_resourcequota{{namespace="{namespace}", resource="requests.memory", type="hard"}} / {memoryLimits})
                    )
                  )
                labels:
                  namespace: default
                  service: {poolName}
    scaledobject.yml: |-
      apiVersion: keda.sh/v1alpha1
      kind: ScaledObject
      metadata:
        name: {poolName}
        namespace: {namespace}
        labels:
          name: {poolName}
      spec:
        scaleTargetRef:
          name: {poolName}
        pollingInterval: 3
        cooldownPeriod:  120
        minReplicaCount: {minReplicaCount}
        maxReplicaCount: 100
        triggers:
          - type: prometheus
            metadata:
              serverAddress: {prometheusUrl}
              metricName: {poolNameUnderscored}:replication_factor
              threshold: '1'
              query: {poolNameUnderscored}:replication_factor{{}}
        advanced:
          horizontalPodAutoscalerConfig:
            behavior:
              scaleUp:
                stabilizationWindowSeconds: 0
                policies:
                  - periodSeconds: 5
                    type: Pods
                    value: 50
              scaleDown:
                stabilizationWindowSeconds: 0
                policies:
                  - periodSeconds: 30
                    type: Pods
                    value: 50

prometheus-adapter:
  enabled: false
  prometheus:
    url: http://monitoring-prometheus
    port: 9090

prometheus-rabbitmq-exporter:
  enabled: false
  # annotations:
  #   prometheus.io/scrape: "true"
  #   prometheus.io/path: "/metrics"
  #   prometheus.io/port: 9419
  prometheus:
    monitor:
      enabled: true
      additionalLabels:
        # release: worker-pools-operator
        release: worker-pool-operator
        # release: kube-prometheus
      interval: 5s
    rules:
      enabled: true
  rabbitmq:
    url: http://rabbitmq:15672

keda:
  enabled: false
  clusterDomain: dev.onedata.uk.to

rabbitmq:
  enabled: false
  fullnameOverride: rabbitmq
  replicaCount: 1

  persistence:
    enabled: false

  auth:
    username: guest
    password: guest
    erlangCookie: jiwng4pw7NJL3KutMb4pF7k6C5RphXYU

  metrics:
    enabled: true
    plugins: "rabbitmq_prometheus"
    serviceMonitor:
      enabled: true
      labels:
        release: worker-pool-operator
        app.kubernetes.io/component: metrics

kube-prometheus-stack:
  enabled: false
  fullnameOverride: monitoring
  defaultRules:
    create: true
    rules:
      alertmanager: false
      etcd: false
      configReloaders: false
      general: true
      k8s: true
      kubeApiserver: true
      kubeApiserverAvailability: false
      kubeApiserverSlos: false
      kubelet: true
      kubeProxy: false
      kubePrometheusGeneral: true
      kubePrometheusNodeRecording: true
      kubernetesApps: true
      kubernetesResources: true
      kubernetesStorage: true
      kubernetesSystem: true
      kubeScheduler: false
      kubeStateMetrics: true
      network: true
      node: true
      nodeExporterAlerting: false
      nodeExporterRecording: true
      prometheus: true
      prometheusOperator: true

    appNamespacesTarget: ".*"

  global:
    rbac:
      create: true
      pspEnabled: false
      pspAnnotations: {}

  alertmanager:
    enabled: false

  grafana:
    enabled: true
    namespaceOverride: ""
    adminPassword: admin

  kubeApiServer:
    enabled: true

  kubelet:
    enabled: true

  kubeControllerManager:
    enabled: false

  coreDns:
    enabled: false

  kubeDns:
    enabled: false

  kubeEtcd:
    enabled: false

  kubeScheduler:
    enabled: false

  kubeProxy:
    enabled: false

  kubeStateMetrics:
    enabled: true

  kube-state-metrics:
    namespaceOverride: ""
    rbac:
      create: true
      extraRules:
        - apiGroups: ["autoscaling.k8s.io", "apiextensions.k8s.io"]
          resources: ["verticalpodautoscalers", "customresourcedefinitions"]
          verbs: ["list", "watch"]
    releaseLabel: true
    prometheus:
      monitor:
        enabled: true
    # customResourceState:
    #   enabled: true
    #   config:
    #     kind: CustomResourceStateMetrics
    #     spec:
    #       resources:
    #         - groupVersionKind:
    #             group: autoscaling.k8s.io
    #             kind: "VerticalPodAutoscaler"
    #             version: "v1"
    #           labelsFromPath:
    #             verticalpodautoscaler: [metadata, name]
    #             namespace: [metadata, namespace]
    #             target_api_version: [spec, targetRef, apiVersion]
    #             target_kind: [spec, targetRef, kind]
    #             target_name: [spec, targetRef, name]
    #           metrics:
    #             # Labels
    #             - name: "verticalpodautoscaler_labels"
    #               help: "VPA container recommendations. Kubernetes labels converted to Prometheus labels"
    #               each:
    #                 type: Info
    #                 info:
    #                   labelsFromPath:
    #                     name: [metadata, name]
    #             # Memory Information
    #             - name: "verticalpodautoscaler_status_recommendation_containerrecommendations_target"
    #               help: "VPA container recommendations for memory. Target resources the VerticalPodAutoscaler recommends for the container."
    #               each:
    #                 type: Gauge
    #                 gauge:
    #                   path: [status, recommendation, containerRecommendations]
    #                   valueFrom: [target, memory]
    #                   labelsFromPath:
    #                     container: [containerName]
    #               commonLabels:
    #                 resource: "memory"
    #                 unit: "byte"
    #             - name: "verticalpodautoscaler_status_recommendation_containerrecommendations_lowerbound"
    #               help: "VPA container recommendations for memory. Minimum resources the container can use before the VerticalPodAutoscaler updater evicts it"
    #               each:
    #                 type: Gauge
    #                 gauge:
    #                   path: [status, recommendation, containerRecommendations]
    #                   valueFrom: [lowerBound, memory]
    #                   labelsFromPath:
    #                     container: [containerName]
    #               commonLabels:
    #                 resource: "memory"
    #                 unit: "byte"
    #             - name: "verticalpodautoscaler_status_recommendation_containerrecommendations_upperbound"
    #               help: "VPA container recommendations for memory. Maximum resources the container can use before the VerticalPodAutoscaler updater evicts it"
    #               each:
    #                 type: Gauge
    #                 gauge:
    #                   path: [status, recommendation, containerRecommendations]
    #                   valueFrom: [upperBound, memory]
    #                   labelsFromPath:
    #                     container: [containerName]
    #               commonLabels:
    #                 resource: "memory"
    #                 unit: "byte"
    #             - name: "verticalpodautoscaler_status_recommendation_containerrecommendations_uncappedtarget"
    #               help: "VPA container recommendations for memory. Target resources the VerticalPodAutoscaler recommends for the container ignoring bounds"
    #               each:
    #                 type: Gauge
    #                 gauge:
    #                   path: [status, recommendation, containerRecommendations]
    #                   valueFrom: [uncappedTarget, memory]
    #                   labelsFromPath:
    #                     container: [containerName]
    #               commonLabels:
    #                 resource: "memory"
    #                 unit: "byte"
    #             # CPU Information
    #             - name: "verticalpodautoscaler_status_recommendation_containerrecommendations_target"
    #               help: "VPA container recommendations for cpu. Target resources the VerticalPodAutoscaler recommends for the container."
    #               each:
    #                 type: Gauge
    #                 gauge:
    #                   path: [status, recommendation, containerRecommendations]
    #                   valueFrom: [target, cpu]
    #                   labelsFromPath:
    #                     container: [containerName]
    #               commonLabels:
    #                 resource: "cpu"
    #                 unit: "core"
    #             - name: "verticalpodautoscaler_status_recommendation_containerrecommendations_lowerbound"
    #               help: "VPA container recommendations for cpu. Minimum resources the container can use before the VerticalPodAutoscaler updater evicts it"
    #               each:
    #                 type: Gauge
    #                 gauge:
    #                   path: [status, recommendation, containerRecommendations]
    #                   valueFrom: [lowerBound, cpu]
    #                   labelsFromPath:
    #                     container: [containerName]
    #               commonLabels:
    #                 resource: "cpu"
    #                 unit: "core"
    #             - name: "verticalpodautoscaler_status_recommendation_containerrecommendations_upperbound"
    #               help: "VPA container recommendations for cpu. Maximum resources the container can use before the VerticalPodAutoscaler updater evicts it"
    #               each:
    #                 type: Gauge
    #                 gauge:
    #                   path: [status, recommendation, containerRecommendations]
    #                   valueFrom: [upperBound, cpu]
    #                   labelsFromPath:
    #                     container: [containerName]
    #               commonLabels:
    #                 resource: "cpu"
    #                 unit: "core"
    #             - name: "verticalpodautoscaler_status_recommendation_containerrecommendations_uncappedtarget"
    #               help: "VPA container recommendations for cpu. Target resources the VerticalPodAutoscaler recommends for the container ignoring bounds"
    #               each:
    #                 type: Gauge
    #                 gauge:
    #                   path: [status, recommendation, containerRecommendations]
    #                   valueFrom: [uncappedTarget, cpu]
    #                   labelsFromPath:
    #                     container: [containerName]
    #               commonLabels:
    #                 resource: "cpu"
    #                 unit: "core"
    # selfMonitor:
    #   enabled: true

  nodeExporter:
    enabled: true

  prometheusOperator:
    enabled: true

  prometheus:
    enabled: true
    prometheusSpec:
      scrapeInterval: 5s
      ruleSelectorNilUsesHelmValues: false
      podMonitorSelectorNilUsesHelmValues: false
      serviceMonitorSelectorNilUsesHelmValues: false
      probeSelectorNilUsesHelmValues: false
      # podMonitorNamespaceSelector: {}
      # podMonitorSelector:
      #   matchLabels:
      #     release: worker-pool-operator
      # serviceMonitorNamespaceSelector: {}
      # serviceMonitorSelector:
      #   matchLabels:
      #     release: worker-pool-operator

vertical-pod-autoscaler:
  enabled: false
  recommender:
    extraArgs:
      # recommendation-margin-fraction: 0.1
      recommendation-margin-fraction: 0.0
      pod-recommendation-min-cpu-millicores: 100
      pod-recommendation-min-memory-mb: 100
      cpu-histogram-decay-half-life: 0h3m0s
      memory-aggregation-interval: 0h2m00s
      memory-histogram-decay-half-life: 0h3m0s
      recommender-interval: 0h0m30s
      history-length: "1h"
      history-resolution: "5m"
    metrics:
      serviceMonitor:
        enabled: true 
        labels:
          release: worker-pool-operator
          app.kubernetes.io/component: metrics
  updater:
    extraArgs:
      # updater-interval: 0h1m00s
      # eviction-rate-burst: 3
      updater-interval: 0h0m30s
      eviction-rate-burst: 20
      eviction-tolerance: 1
  #     eviction-rate-limit: -1

kube-state-metrics:
  enabled: false
#   namespaceOverride: ""
#   rbac:
#     create: true
#   releaseLabel: true
#   prometheus:
#     monitor:
#       enabled: true
#   customResourceState:
#     enabled: true
#     config: |
#               spec:
#                 resources:
#                   - groupVersionKind:
#                       group: autoscaling.k8s.io
#                       kind: "VerticalPodAutoscaler"
#                       version: "v1"
#                     labelsFromPath:
#                       verticalpodautoscaler: [metadata, name]
#                       namespace: [metadata, namespace]
#                       target_api_version: [apiVersion]
#                       target_kind: [spec, targetRef, kind]
#                       target_name: [spec, targetRef, name]
#                     metrics:
#                       - name: "worker_cpu_usage"
#                         help: "Kubernetes annotations converted to Prometheus labels."
#                         each:
#                           type: Gauge
#                           gauge:
#                             path: [status, recommendation, containerRecommendations, target, memory]